{% extends 'base.html' %}
{% block title %}Carrito de Compras{% endblock %}

{% block content %}
<div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 px-3"
    style="background: #f5f5dc;">
    <div class="card shadow-lg bg-white rounded-4 p-4 m-4 col-lg-9 col-md-10 col-sm-12">
        <h2 class="text-center text-success fw-bold mt-2 mb-4">Carrito de Compras</h2>
        <hr class="border-1 opacity-75 mt-1">

        {% if cart %}
        <div class="table-responsive" style="background-color: f5f5dc;">
            <table class="table table-borderless table-hover rounded-3 overflow-hidden">
                <thead class="text-white" style="background-color: #b58863;">
                    <tr>
                        <th class="text-center">Planta</th>
                        <th class="text-center">Precio</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-center">Subtotal</th>
                        <th class="text-center"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, item in cart.items %}
                    <tr>
                        <td class="align-middle text-center">{{ item.name }}</td>
                        <td class="align-middle text-center">${{ item.price }}</td>
                        <td class="align-middle text-center">
                            <div class="d-flex justify-content-center">
                                <input type="number" id="quantity-{{ key }}" value="{{ item.quantity }}"
                                    class="form-control text-center"
                                    style="width: 80px; text-align: center; margin: auto;" min="1"
                                    onchange="updateQuantity('{{ key }}')">
                            </div>
                        </td>
                        <td class="align-middle text-center" id="subtotal-{{ key }}">${{ item.subtotal }}</td>
                        <td class="align-middle text-center">
                            <a href="{% url 'remove_from_cart' key %}" class="btn btn-danger btn-sm fw-bold shadow-sm">
                                <ion-icon name="trash-outline"></ion-icon>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <hr class="border-1 opacity-75 mt-1">

        <!-- Sección total separada y alineada a la derecha -->
        <div class="d-flex justify-content-end mt-3">
            <h5><strong>Total: $<span id="cart-total">{{ total }}</span></strong></h5>
        </div>
        {% else %}
        <p class="text-center">Tu carrito está vacío</p>
        {% endif %}


        <!-- Botones de navegación -->
        <div class="mt-4 d-flex justify-content-between">
            <a href="{% url 'catalogoPlantas' %}" class="btn fw-bold shadow"
                style="background-color: #b58863; color: white;">Volver al Catálogo</a>
            <a href="{% url 'catalogoPlantas' %}" class="btn fw-bold shadow"
                style="background-color: #28a745; color: white;">Comprar</a>
        </div>

    </div>
</div>

<script>
    function updateQuantity(plantId) {
        let quantityInput = document.getElementById('quantity-' + plantId);
        let newQuantity = parseInt(quantityInput.value);

        if (newQuantity < 1) {
            window.location.href = `/cart/remove/${plantId}/`;  // Si llega a 0, elimina el producto
        } else {
            fetch(`/cart/update/${plantId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `quantity=${newQuantity}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('subtotal-' + plantId).innerText = `$${data.subtotal}`;
                        document.getElementById('cart-total').innerText = `$${data.total}`;
                    }
                });
        }
    }
</script>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
{% endblock %}